# Обновление приложений

>## Цель задания
>
>Выбрать и настроить стратегию обновления приложения.
>
>## Чеклист готовности к домашнему заданию
>
>1. Кластер K8s.
>
>## Инструменты и дополнительные материалы, которые пригодятся для выполнения задания
>
>1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment).
>2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/).

-----

## Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

>1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
>2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
>3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
>4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
>5. Вам нужно объяснить свой выбор стратегии обновления приложения.

### Ответ

Исходя из пунктов 2 и 3 получаем, что в у нас просто есть "окно" на обновление, когда часть ресурсов высвобождается, а по завершении этого окна "лишних" ресурсов нет. Это значит, что параллельно поднимать 2 версии приложения, чтобы проверить его работоспособность, не имеет смысла (даже без учёта пункта 4). Тем самым от стратегий обновления `Blue/Green`, `Canary` и `A/B-теста` сразу отказываемся. Остаются варианты `Rolling Update` и `Recreate`. 

Если пункт 4 предполагает, что невозможно иметь поды с новой и старой версиями, то единственным выбором будет стратегия развёртывания `Recreate` с полной остановкой в обслуживании клиентов. Нужно выбрать подходящее время, уведомить потребителей и провести обновление. 

Если пункт 4 всё же допускает параллельный запуск подов разных версий, то в окно обновления стоит запустить `Rolling Update` с параметрами `maxSurge: 20%` и `maxUnavailable: 0`, чтобы не прерывать обслуживание клиентов. 

## Задание 2. Обновить приложение

>1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
>2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
>3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
>4. Откатиться после неудачного обновления.

## ~~Задание 3*. Создать Canary deployment~~

>1. Создать два deployment'а приложения nginx.
>2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
>3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.
